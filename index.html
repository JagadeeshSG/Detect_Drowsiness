<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="DrowsyGuard" />
  <meta name="theme-color" content="#0f172a" />
  <title>DrowsyGuard</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0f172a;
      --surface: #1e293b;
      --border: #334155;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --accent: #6366f1;
      --green: #22c55e;
      --yellow: #f59e0b;
      --red: #ef4444;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-icon {
      width: 36px; height: 36px;
      background: var(--accent);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }
    .logo-text { font-size: 18px; font-weight: 700; letter-spacing: -0.3px; }
    .logo-sub  { font-size: 11px; color: var(--muted); }

    .status-pill {
      display: flex; align-items: center; gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px; font-weight: 600;
      background: var(--border);
      transition: all 0.3s;
    }
    .status-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--muted); transition: background 0.3s;
    }
    .status-pill.active .status-dot { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .status-pill.drowsy .status-dot { background: var(--red);   box-shadow: 0 0 6px var(--red); }
    .status-pill.calib  .status-dot { background: var(--yellow);box-shadow: 0 0 6px var(--yellow); }

    main {
      flex: 1;
      display: flex; flex-direction: column; align-items: center;
      padding: 16px; gap: 14px;
      overflow-y: auto;
    }

    .video-wrap {
      position: relative;
      width: 100%; max-width: 480px;
      aspect-ratio: 4/3;
      border-radius: 20px; overflow: hidden;
      background: #000;
      border: 2px solid var(--border);
      transition: border-color 0.3s, box-shadow 0.3s;
      flex-shrink: 0;
    }
    .video-wrap.alert-border  { border-color: var(--red);    box-shadow: 0 0 24px rgba(239,68,68,0.45); }
    .video-wrap.calib-border  { border-color: var(--yellow); box-shadow: 0 0 16px rgba(245,158,11,0.3); }
    .video-wrap.active-border { border-color: var(--green);  box-shadow: 0 0 10px rgba(34,197,94,0.2); }

    video {
      width: 100%; height: 100%;
      object-fit: cover; transform: scaleX(-1); display: block;
    }
    canvas#overlay {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      transform: scaleX(-1); pointer-events: none;
    }

    /* Alert overlay */
    .alert-overlay {
      position: absolute; inset: 0;
      background: rgba(239,68,68,0.28);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 8px;
      opacity: 0; transition: opacity 0.2s; pointer-events: none;
    }
    .alert-overlay.show { opacity: 1; }
    .alert-text {
      font-size: 28px; font-weight: 900; color: #fff;
      text-shadow: 0 2px 8px rgba(0,0,0,0.8); letter-spacing: 2px;
      animation: pulse-txt 0.5s ease-in-out infinite alternate;
    }
    .alert-emoji { font-size: 48px; animation: pulse-txt 0.5s ease-in-out infinite alternate; }
    @keyframes pulse-txt { from { transform: scale(1); } to { transform: scale(1.09); } }

    /* Calibration overlay */
    .calib-overlay {
      position: absolute; inset: 0;
      background: rgba(15,23,42,0.72);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 10px;
      opacity: 0; transition: opacity 0.25s; pointer-events: none;
    }
    .calib-overlay.show { opacity: 1; }
    .calib-title { font-size: 16px; font-weight: 800; color: #fde68a; }
    .calib-sub   { font-size: 12px; color: #fcd34d; text-align: center; padding: 0 24px; line-height: 1.5; }
    .calib-track {
      width: 160px; height: 8px;
      background: rgba(255,255,255,0.15); border-radius: 99px; overflow: hidden;
    }
    .calib-fill {
      height: 100%; border-radius: 99px;
      background: var(--yellow); width: 0%; transition: width 0.1s linear;
    }

    /* Loading overlay */
    .loading-overlay {
      position: absolute; inset: 0;
      background: rgba(15,23,42,0.88);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 12px;
      border-radius: 18px;
    }
    .loading-overlay.hidden { display: none; }
    .spinner {
      width: 36px; height: 36px;
      border: 3px solid var(--border); border-top-color: var(--accent);
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { font-size: 13px; color: var(--muted); }

    /* Metrics */
    .metrics {
      display: grid; grid-template-columns: repeat(3, 1fr);
      gap: 10px; width: 100%; max-width: 480px;
    }
    .metric-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 12px 10px; text-align: center;
    }
    .metric-label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .metric-value { font-size: 22px; font-weight: 800; }
    .metric-unit  { font-size: 10px; color: var(--muted); }
    .ear-value      { color: var(--green); }
    .ear-value.low  { color: var(--red); }
    .ear-value.mid  { color: var(--yellow); }

    /* Eye bar */
    .eye-bar-wrap {
      width: 100%; max-width: 480px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 14px 16px;
    }
    .eye-bar-label { font-size: 12px; color: var(--muted); margin-bottom: 8px; display: flex; justify-content: space-between; }
    .eye-bar-track { height: 10px; border-radius: 99px; background: var(--border); overflow: hidden; }
    .eye-bar-fill  {
      height: 100%; border-radius: 99px; background: var(--green);
      transition: width 0.12s, background 0.3s; width: 0%;
    }

    /* Calibration info */
    .calib-info {
      width: 100%; max-width: 480px;
      background: rgba(245,158,11,0.08);
      border: 1px solid rgba(245,158,11,0.25);
      border-radius: 14px; padding: 10px 16px;
      font-size: 12px; color: #fcd34d; text-align: center;
      display: none;
    }
    .calib-info.show { display: block; }

    /* Controls */
    .controls { display: flex; gap: 12px; width: 100%; max-width: 480px; }
    .btn {
      flex: 1; padding: 14px; border-radius: 14px; border: none;
      font-size: 15px; font-weight: 700; cursor: pointer;
      transition: all 0.15s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn:active { transform: scale(0.97); }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:disabled { background: var(--border); color: var(--muted); cursor: not-allowed; }
    .btn-danger  { background: #7f1d1d; color: #fca5a5; }
    .btn-mute    {
      background: var(--surface); color: var(--text);
      border: 1px solid var(--border); flex: 0 0 auto; padding: 14px 18px;
    }
    .btn-mute.muted { color: var(--red); border-color: var(--red); }
    .hidden { display: none !important; }

    /* Settings */
    .settings-card {
      width: 100%; max-width: 480px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 16px;
    }
    .settings-title { font-size: 13px; font-weight: 700; margin-bottom: 14px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .setting-row {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;
    }
    .setting-row:last-child { margin-bottom: 0; }
    .setting-label { font-size: 13px; }
    .setting-sub   { font-size: 11px; color: var(--muted); }
    input[type=range] { width: 110px; accent-color: var(--accent); }
    .range-val { font-size: 12px; color: var(--accent); font-weight: 700; min-width: 36px; text-align: right; }

    /* Toast */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: var(--surface); border: 1px solid var(--border);
      color: var(--text); padding: 10px 20px;
      border-radius: 99px; font-size: 13px; font-weight: 600;
      opacity: 0; transition: opacity 0.3s;
      pointer-events: none; z-index: 999; white-space: nowrap;
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">ğŸ‘ï¸</div>
    <div>
      <div class="logo-text">DrowsyGuard</div>
      <div class="logo-sub">Drowsiness Detection</div>
    </div>
  </div>
  <div class="status-pill" id="statusPill">
    <div class="status-dot"></div>
    <span id="statusText">Stopped</span>
  </div>
</header>

<main>

  <!-- Video + overlays -->
  <div class="video-wrap" id="videoWrap">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="overlay"></canvas>

    <div class="alert-overlay" id="alertOverlay">
      <div class="alert-emoji">ğŸ˜´</div>
      <div class="alert-text">WAKE UP!</div>
    </div>

    <div class="calib-overlay" id="calibOverlay">
      <div class="calib-title">ğŸ‘€ Calibratingâ€¦</div>
      <div class="calib-sub">Keep your eyes open and look at the camera</div>
      <div class="calib-track"><div class="calib-fill" id="calibFill"></div></div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
      <div class="loading-text" id="loadingText">Loadingâ€¦</div>
    </div>
  </div>

  <!-- Metrics -->
  <div class="metrics">
    <div class="metric-card">
      <div class="metric-label">Eye Ratio</div>
      <div class="metric-value ear-value" id="earDisplay">â€“</div>
      <div class="metric-unit">EAR</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Closed For</div>
      <div class="metric-value" id="closedDisplay" style="color:var(--muted)">0.0</div>
      <div class="metric-unit">seconds</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Alerts</div>
      <div class="metric-value" id="alertCount" style="color:var(--accent)">0</div>
      <div class="metric-unit">total</div>
    </div>
  </div>

  <!-- Eye openness bar -->
  <div class="eye-bar-wrap">
    <div class="eye-bar-label">
      <span>Eye Openness</span>
      <span id="eyeBarPct">â€“</span>
    </div>
    <div class="eye-bar-track">
      <div class="eye-bar-fill" id="eyeBarFill"></div>
    </div>
  </div>

  <!-- Calibration result info -->
  <div class="calib-info" id="calibInfo">
    âœ… Calibrated â€” your open-eye baseline: <strong id="baselineDisplay">â€“</strong> &nbsp;|&nbsp; alert threshold: <strong id="threshDisplay">â€“</strong>
  </div>

  <!-- Controls -->
  <div class="controls">
    <button class="btn btn-primary" id="startBtn" onclick="startDetection()">â–¶ Start</button>
    <button class="btn btn-danger hidden" id="stopBtn" onclick="stopDetection()">â–  Stop</button>
    <button class="btn btn-mute" id="muteBtn" onclick="toggleMute()">ğŸ””</button>
  </div>

  <!-- Settings -->
  <div class="settings-card">
    <div class="settings-title">âš™ï¸ Settings</div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Sensitivity</div>
        <div class="setting-sub">% of baseline â€” lower = triggers sooner</div>
      </div>
      <input type="range" id="sensitivitySlider" min="55" max="85" step="5" value="80" oninput="updateSettings()">
      <span class="range-val" id="sensitivityVal">80%</span>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Alert Delay</div>
        <div class="setting-sub">Seconds before alarm fires</div>
      </div>
      <input type="range" id="alertDelay" min="0.5" max="4" step="0.5" value="1.5" oninput="updateSettings()">
      <span class="range-val" id="alertDelayVal">1.5s</span>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Alarm Volume</div>
        <div class="setting-sub">Loudness of the alarm</div>
      </div>
      <input type="range" id="alarmVol" min="0" max="1" step="0.1" value="0.9" oninput="updateSettings()">
      <span class="range-val" id="alarmVolVal">90%</span>
    </div>
  </div>

</main>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/face_mesh.js" crossorigin="anonymous"></script>

<script>
// â”€â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CALIB_FRAMES = 60;    // ~3 sec worth of frames at ~20fps
let   SENSITIVITY  = 0.75;  // threshold = baseline * SENSITIVITY
let   ALERT_DELAY  = 1.5;
let   alarmVolume  = 0.9;

// Threshold â€” overwritten after calibration; safe fallback until then
let EAR_THRESH = 0.18;

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let faceMesh      = null;
let rafId         = null;
let running       = false;
let muted         = false;
let alertCountVal = 0;

// Calibration
let calibrating  = false;
let calibSamples = [];
let baselineEAR  = null;

// Timing
let eyesClosedStart = null;
let alarmPlaying    = false;
let audioCtx        = null;
let alarmNodes      = [];

// Smoothing buffer â€” averages last N raw EAR values to reduce noise
const SMOOTH_N  = 6;
let   earBuffer = [];

// MediaPipe eye landmark indices (468-point mesh)
const LEFT_EYE  = [362, 385, 387, 263, 373, 380];
const RIGHT_EYE = [ 33, 160, 158, 133, 153, 144];

// â”€â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

function startAlarm() {
  if (alarmPlaying || muted) return;
  alarmPlaying = true;
  const ctx = getAudioCtx();
  if (ctx.state === 'suspended') ctx.resume();
  const pattern = [880, 1100, 880, 660];
  let t = ctx.currentTime;
  function loop() {
    if (!alarmPlaying) return;
    pattern.forEach((freq, i) => {
      const osc = ctx.createOscillator(), gain = ctx.createGain();
      osc.frequency.value = freq; osc.type = 'square';
      gain.gain.setValueAtTime(0, t + i * 0.12);
      gain.gain.linearRampToValueAtTime(alarmVolume * 0.35, t + i * 0.12 + 0.02);
      gain.gain.linearRampToValueAtTime(0, t + i * 0.12 + 0.10);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(t + i * 0.12); osc.stop(t + i * 0.12 + 0.12);
      alarmNodes.push(osc);
    });
    t += pattern.length * 0.12 + 0.08;
    setTimeout(loop, (pattern.length * 0.12 + 0.08) * 1000);
  }
  loop();
}

function stopAlarm() {
  alarmPlaying = false;
  alarmNodes.forEach(n => { try { n.stop(); } catch(e){} });
  alarmNodes = [];
}

// â”€â”€â”€ EAR calculation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function edist(a, b) {
  return Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
}
function computeEAR(lm, idx) {
  const [p1,p2,p3,p4,p5,p6] = idx.map(i => lm[i]);
  return (edist(p2,p6) + edist(p3,p5)) / (2.0 * edist(p1,p4));
}
function smoothEAR(raw) {
  earBuffer.push(raw);
  if (earBuffer.length > SMOOTH_N) earBuffer.shift();
  return earBuffer.reduce((a,b) => a+b, 0) / earBuffer.length;
}

// â”€â”€â”€ MediaPipe init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initFaceMesh() {
  return new Promise((resolve, reject) => {
    try {
      const fm = new FaceMesh({
        locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/${f}`
      });
      fm.setOptions({
        maxNumFaces: 1,
        refineLandmarks: false,
        minDetectionConfidence: 0.6,
        minTrackingConfidence: 0.6
      });
      fm.onResults(onResults);
      fm.initialize().then(() => resolve(fm)).catch(reject);
    } catch(e) { reject(e); }
  });
}

// â”€â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const videoEl = document.getElementById('video');
const canvas  = document.getElementById('overlay');
const ctx2d   = canvas.getContext('2d');

function onResults(results) {
  const W = videoEl.videoWidth || 640, H = videoEl.videoHeight || 480;
  canvas.width = W; canvas.height = H;
  ctx2d.clearRect(0, 0, W, H);

  if (!results.multiFaceLandmarks || !results.multiFaceLandmarks.length) {
    updateDisplay(null);
    return;
  }

  const lm     = results.multiFaceLandmarks[0];
  const rawEAR = (computeEAR(lm, LEFT_EYE) + computeEAR(lm, RIGHT_EYE)) / 2;
  const ear    = smoothEAR(rawEAR);
  const closed = ear < EAR_THRESH;

  // Draw eye contours
  [LEFT_EYE, RIGHT_EYE].forEach(indices => {
    ctx2d.beginPath();
    indices.forEach((idx, i) => {
      const x = lm[idx].x * W, y = lm[idx].y * H;
      i === 0 ? ctx2d.moveTo(x,y) : ctx2d.lineTo(x,y);
    });
    ctx2d.closePath();
    ctx2d.strokeStyle = closed ? '#ef4444' : '#22c55e';
    ctx2d.lineWidth = 2.5; ctx2d.stroke();
    ctx2d.fillStyle = closed ? 'rgba(239,68,68,0.18)' : 'rgba(34,197,94,0.12)';
    ctx2d.fill();
  });

  updateDisplay(ear, closed);

  // â”€â”€ Calibration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (calibrating) {
    calibSamples.push(ear);
    document.getElementById('calibFill').style.width =
      Math.min(100, (calibSamples.length / CALIB_FRAMES) * 100) + '%';
    if (calibSamples.length >= CALIB_FRAMES) finishCalibration();
    return; // skip drowsiness check during calibration
  }

  checkDrowsiness(ear, closed);
}

// â”€â”€â”€ Calibration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startCalibration() {
  calibrating  = true;
  calibSamples = [];
  earBuffer    = [];
  document.getElementById('calibOverlay').classList.add('show');
  document.getElementById('videoWrap').classList.add('calib-border');
  document.getElementById('videoWrap').classList.remove('active-border');
  setStatus('calib', 'Calibratingâ€¦');
}

function finishCalibration() {
  calibrating = false;
  // Use median â€” robust to blinks during calibration
  const sorted = [...calibSamples].sort((a,b) => a-b);
  baselineEAR  = sorted[Math.floor(sorted.length / 2)];
  EAR_THRESH   = baselineEAR * SENSITIVITY;

  document.getElementById('calibOverlay').classList.remove('show');
  document.getElementById('videoWrap').classList.remove('calib-border');
  document.getElementById('videoWrap').classList.add('active-border');
  document.getElementById('baselineDisplay').textContent = baselineEAR.toFixed(3);
  document.getElementById('threshDisplay').textContent   = EAR_THRESH.toFixed(3);
  document.getElementById('calibInfo').classList.add('show');
  setStatus('active', 'Monitoring');
  showToast('âœ… Calibrated! Monitoring started.');
}

// â”€â”€â”€ Drowsiness â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkDrowsiness(ear, closed) {
  const now = Date.now();
  if (closed) {
    if (!eyesClosedStart) eyesClosedStart = now;
    const elapsed = (now - eyesClosedStart) / 1000;
    document.getElementById('closedDisplay').textContent = elapsed.toFixed(1);
    document.getElementById('closedDisplay').style.color =
      elapsed > ALERT_DELAY * 0.5 ? '#f59e0b' : 'var(--muted)';
    if (elapsed >= ALERT_DELAY) triggerAlert();
  } else {
    if (eyesClosedStart) dismissAlert();
    eyesClosedStart = null;
    document.getElementById('closedDisplay').textContent = '0.0';
    document.getElementById('closedDisplay').style.color = 'var(--muted)';
  }
}

function triggerAlert() {
  if (!document.getElementById('alertOverlay').classList.contains('show')) {
    alertCountVal++;
    document.getElementById('alertCount').textContent = alertCountVal;
  }
  document.getElementById('alertOverlay').classList.add('show');
  document.getElementById('videoWrap').classList.add('alert-border');
  document.getElementById('videoWrap').classList.remove('active-border');
  setStatus('drowsy', 'âš ï¸ Drowsy!');
  startAlarm();
  if (navigator.vibrate) navigator.vibrate([400,100,400,100,400]);
}

function dismissAlert() {
  document.getElementById('alertOverlay').classList.remove('show');
  document.getElementById('videoWrap').classList.remove('alert-border');
  document.getElementById('videoWrap').classList.add('active-border');
  setStatus('active', 'Monitoring');
  stopAlarm();
}

// â”€â”€â”€ Display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDisplay(ear, closed) {
  const earEl = document.getElementById('earDisplay');
  if (ear === null) {
    earEl.textContent = 'â€“'; earEl.className = 'metric-value ear-value';
    document.getElementById('eyeBarFill').style.width = '0%';
    document.getElementById('eyeBarPct').textContent  = 'No face';
    return;
  }
  const ref = baselineEAR || 0.35;
  const pct = Math.min(100, Math.round((ear / ref) * 100));
  earEl.textContent = ear.toFixed(3);
  earEl.className   = 'metric-value ear-value' + (closed ? ' low' : ear < EAR_THRESH + 0.02 ? ' mid' : '');
  const fill = document.getElementById('eyeBarFill');
  fill.style.width      = pct + '%';
  fill.style.background = closed ? '#ef4444' : ear < EAR_THRESH + 0.02 ? '#f59e0b' : '#22c55e';
  document.getElementById('eyeBarPct').textContent = pct + '%';
}

// â”€â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startDetection() {
  if (running) return;
  const loadOverlay = document.getElementById('loadingOverlay');
  loadOverlay.classList.remove('hidden');
  document.getElementById('loadingText').textContent = 'Requesting cameraâ€¦';
  document.getElementById('startBtn').disabled = true;

  try {
    getAudioCtx(); // init on user gesture

    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
      audio: false
    });
    videoEl.srcObject = stream;
    await videoEl.play();

    document.getElementById('loadingText').textContent = 'Loading face modelâ€¦';
    if (!faceMesh) faceMesh = await initFaceMesh();

    running = true;
    async function frameLoop() {
      if (!running) return;
      if (videoEl.readyState >= 2) {
        try { await faceMesh.send({ image: videoEl }); } catch(e) {}
      }
      rafId = requestAnimationFrame(frameLoop);
    }
    rafId = requestAnimationFrame(frameLoop);

    loadOverlay.classList.add('hidden');
    document.getElementById('startBtn').classList.add('hidden');
    document.getElementById('stopBtn').classList.remove('hidden');
    startCalibration();

  } catch(err) {
    loadOverlay.classList.add('hidden');
    document.getElementById('startBtn').disabled = false;
    console.error(err);
    showToast(err.name === 'NotAllowedError'
      ? 'âŒ Camera permission denied'
      : 'âŒ Error: ' + err.message);
    setStatus('', 'Stopped');
  }
}

function stopDetection() {
  if (!running) return;
  running = false; calibrating = false;

  if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
  if (videoEl.srcObject) {
    videoEl.srcObject.getTracks().forEach(t => t.stop());
    videoEl.srcObject = null;
  }

  stopAlarm();
  eyesClosedStart = null; earBuffer = []; baselineEAR = null;

  ['alertOverlay','calibOverlay'].forEach(id => document.getElementById(id).classList.remove('show'));
  document.getElementById('calibInfo').classList.remove('show');
  document.getElementById('videoWrap').classList.remove('alert-border','active-border','calib-border');
  document.getElementById('stopBtn').classList.add('hidden');
  document.getElementById('startBtn').classList.remove('hidden');
  document.getElementById('startBtn').disabled = false;
  document.getElementById('earDisplay').textContent    = 'â€“';
  document.getElementById('closedDisplay').textContent = '0.0';
  document.getElementById('eyeBarFill').style.width    = '0%';
  document.getElementById('eyeBarPct').textContent     = 'â€“';
  ctx2d.clearRect(0, 0, canvas.width, canvas.height);
  setStatus('', 'Stopped');
  showToast('â¹ Detection stopped');
}

function toggleMute() {
  muted = !muted;
  document.getElementById('muteBtn').textContent = muted ? 'ğŸ”‡' : 'ğŸ””';
  document.getElementById('muteBtn').classList.toggle('muted', muted);
  if (muted) stopAlarm();
  showToast(muted ? 'ğŸ”‡ Alarm muted' : 'ğŸ”” Alarm enabled');
}

function setStatus(type, text) {
  document.getElementById('statusPill').className = 'status-pill ' + type;
  document.getElementById('statusText').textContent = text;
}

function updateSettings() {
  SENSITIVITY = parseInt(document.getElementById('sensitivitySlider').value) / 100;
  ALERT_DELAY = parseFloat(document.getElementById('alertDelay').value);
  alarmVolume = parseFloat(document.getElementById('alarmVol').value);
  document.getElementById('sensitivityVal').textContent = Math.round(SENSITIVITY * 100) + '%';
  document.getElementById('alertDelayVal').textContent  = ALERT_DELAY + 's';
  document.getElementById('alarmVolVal').textContent    = Math.round(alarmVolume * 100) + '%';
  // Update live threshold if calibrated
  if (baselineEAR) {
    EAR_THRESH = baselineEAR * SENSITIVITY;
    document.getElementById('threshDisplay').textContent = EAR_THRESH.toFixed(3);
  }
}

let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

// Service worker for offline caching
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(err => console.warn('SW:', err));
}
</script>
</body>
</html>
